# Role-Based Access Control (RBAC) Implementation Guide

## Overview
This document provides a complete guide to the Role-Based Access Control system implemented in the WasteFreeBD Flutter application.

## System Architecture

### User Roles
The system supports 4 user roles with different access levels:

1. **Admin** - Full system access
   - Dashboard overview
   - Financial management
   - Inventory management
   - Waste stock tracking
   - Worker management
   
2. **Manager** (Management) - Operational management
   - Inventory management
   - Waste stock tracking
   - Worker management
   
3. **Accountant** - Financial operations
   - Financial overview only
   
4. **User** (Regular) - Basic access
   - User dashboard
   - General information

## Setup Instructions

### Step 1: Create Supabase Table

1. Go to your [Supabase Dashboard](https://app.supabase.com)
2. Navigate to the SQL Editor
3. Copy and paste the contents of `SUPABASE_SETUP.sql` in this project
4. Execute the SQL queries

This will create:
- `public.signin` table with proper schema
- Test user accounts for each role
- Necessary indexes and Row Level Security policies

### Step 2: Verify Test Users

Test credentials for development:

| Role | Email | Password |
|------|-------|----------|
| Admin | admin@wastefreebd.com | admin123 |
| Manager | manager@wastefreebd.com | manager123 |
| Accountant | accountant@wastefreebd.com | accountant123 |
| User | user@wastefreebd.com | user123 |

### Step 3: Run the Project

**IMPORTANT:** Always run from the project root directory:

```bash
cd c:\Users\Youtech BD\OneDrive\Desktop\wastefreeBD\wastefreebd
flutter pub get
flutter run
```

### Step 4: Test the Application

1. **Login Page** - Application starts with the login screen
2. **Test Each Role:**
   - Log in with admin credentials → See Admin Dashboard
   - Log in with manager credentials → See Manager Dashboard
   - Log in with accountant credentials → See Accountant Dashboard
   - Log in with user credentials → See User Dashboard
3. **Logout** - Click the logout icon in the AppBar to logout

## File Structure

### Authentication Related Files

```
lib/
├── pages/
│   └── login_screen.dart          # Main login page
├── services/
│   └── auth_service.dart          # Authentication logic
├── providers/
│   └── auth_provider.dart         # State management for auth
├── models/
│   └── user_model.dart            # User and role models
└── main.dart                       # App entry point with RBAC routing
```

### Dashboard Files (Role-Specific)

```
lib/
├── admin/
│   └── screens/
│       ├── admin_dashboard_screen.dart
│       ├── financial_overview_screen.dart
│       ├── inventory_management_screen.dart
│       ├── waste_stock_screen.dart
│       └── worker_management_screen.dart
├── management/
│   └── screens/
│       └── (inherited from admin)
└── accountant/
    └── screens/
        └── (inherited from admin)
```

## Implementation Details

### AuthProvider (State Management)

The `AuthProvider` class manages authentication state:

```dart
class AuthProvider extends ChangeNotifier {
  AuthUser? _currentUser;
  bool _isLoading = false;
  String? _errorMessage;

  // Key methods:
  Future<bool> login(String email, String password)
  Future<bool> signup({...})
  void setUser(AuthUser user)
  void clearUser()
}
```

### User Model

```dart
enum UserRole {
  admin('admin'),
  management('management'),
  accountant('accountant'),
  user('user');
}

class AuthUser {
  final String id;
  final String email;
  final String fullName;
  final UserRole role;
  final DateTime createdAt;
}
```

### Login Flow

1. User enters email and password on `LoginScreen`
2. `AuthService.signIn()` validates credentials against Supabase
3. If successful, `AuthProvider.setUser()` stores user data
4. Main app redirects to appropriate dashboard based on role
5. User can logout by clicking AppBar logout button

### Role-Based Routing

In `main.dart`, the `Consumer<AuthProvider>` widget automatically routes to:

- **Admin** → `AdminDashboard` (5 screens)
- **Manager** → `ManagementDashboard` (3 screens)
- **Accountant** → `AccountantDashboard` (1 screen - Financial Overview)
- **User** → `UserDashboard` (General dashboard)
- **Not Authenticated** → `LoginScreen`

## Database Schema

### signin Table

```sql
CREATE TABLE public.signin (
  id bigint generated by default as identity primary key,
  created_at timestamp with time zone default now(),
  email character varying not null unique,
  password character varying,
  "Name" text not null,
  role character varying default 'user',
  constraint role_check check (role in ('admin', 'management', 'accountant', 'user'))
);
```

**Columns:**
- `id` - Auto-generated unique identifier
- `created_at` - User account creation timestamp
- `email` - User email (unique, required)
- `password` - Hashed/encrypted password
- `Name` - User's full name
- `role` - User's role (admin, management, accountant, user)

## Security Considerations

### Current Implementation
- Test users are hardcoded for development
- Passwords are stored as plain text (for testing only)
- RLS (Row Level Security) is enabled but basic

### Production Recommendations
1. **Hash Passwords** - Use bcrypt or similar hashing algorithms
2. **Implement JWT** - Use Supabase JWT tokens
3. **Enhanced RLS** - Implement row-level security policies
4. **Audit Logging** - Log all authentication attempts
5. **2FA** - Add two-factor authentication
6. **Password Policy** - Enforce strong password requirements
7. **Session Management** - Implement proper session timeouts
8. **HTTPS Only** - Ensure all communication is encrypted

## Troubleshooting

### "No pubspec.yaml file found"
**Solution:** Ensure you're running commands from `c:\Users\Youtech BD\OneDrive\Desktop\wastefreeBD\wastefreebd` (the project root)

### Login fails with "Invalid email or password"
**Check:**
1. Email and password are entered correctly
2. Supabase table has the user record
3. Role value in database matches expected values

### App crashes on startup
**Check:**
1. Supabase URL and anon key are correct in `main.dart`
2. Supabase project is active and accessible
3. `flutter pub get` has been run

### User sees wrong dashboard after login
**Verify:**
1. User's role in Supabase table is correct
2. Role enum value matches database value exactly (case-sensitive)
3. AuthProvider is properly updating

## Future Enhancements

1. **Biometric Authentication** - Add fingerprint/face ID
2. **Social Login** - Google, Facebook, GitHub integration
3. **Permission-Based Access** - More granular permissions
4. **Audit Trail** - Track user actions
5. **Multi-Language Support** - Localization
6. **Dark Mode** - Theme switching
7. **Email Verification** - Verify user emails
8. **Password Reset** - Self-service password recovery

## Support

For issues or questions:
1. Check the troubleshooting section above
2. Review the code comments in relevant files
3. Check Supabase documentation: https://supabase.com/docs
4. Check Flutter documentation: https://flutter.dev/docs
